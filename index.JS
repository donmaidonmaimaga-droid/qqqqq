const game = document.getElementById("game");
const startBtn = document.getElementById("startBtn");
const restartBtn = document.getElementById("restartBtn");
const successText = document.getElementById("success");
const missText = document.getElementById("miss");
const timeText = document.getElementById("time");
const message = document.getElementById("message");

let eye, pupil;
let success, miss, time, gameOver;
let timer, pupilTimer, blinkTimeout;
let isClosed = false;

// ç›®ã‚’ä½œã‚‹
function createEye() {
  eye = document.createElement("div");
  eye.className = "eye";
  eye.style.left = "100px";
  eye.style.top = "100px";

  pupil = document.createElement("div");
  pupil.className = "pupil";

  eye.appendChild(pupil);
  game.appendChild(eye);
}

// é»’ç›®ãƒ©ãƒ³ãƒ€ãƒ ç§»å‹•
function movePupil() {
  if (isClosed) return;
  const x = Math.random() * 80;
  const y = Math.random() * 20;
  pupil.style.left = 40 + x + "px";
  pupil.style.top = 20 + y + "px";
}

// ãƒ©ãƒ³ãƒ€ãƒ ç¬ã
function blink() {
  if (gameOver) return;

  isClosed = true;
  eye.classList.add("closed");
  pupil.style.display = "none";

  setTimeout(() => {
    isClosed = false;
    eye.classList.remove("closed");
    pupil.style.display = "block";
    scheduleBlink();
  }, 350);
}

function scheduleBlink() {
  const interval = 700 + Math.random() * 900;
  blinkTimeout = setTimeout(blink, interval);
}

// ã‚²ãƒ¼ãƒ é–‹å§‹
function startGame() {
  game.innerHTML = "";
  createEye();

  success = 0;
  miss = 0;
  time = 20;
  gameOver = false;

  successText.textContent = success;
  missText.textContent = miss;
  timeText.textContent = time;
  message.textContent = "";

  game.style.display = "block";
  startBtn.style.display = "none";
  restartBtn.style.display = "none";

  movePupil();
  pupilTimer = setInterval(movePupil, 700);
  scheduleBlink();

  timer = setInterval(() => {
    if (gameOver) return;
    time--;
    timeText.textContent = time;
    if (time === 0) endGame("â° ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—");
  }, 1000);
}

// ã‚¯ãƒªãƒƒã‚¯ â†’ ç›®è–¬ç”Ÿæˆ
game.addEventListener("click", (e) => {
  if (gameOver) return;

  const rect = game.getBoundingClientRect();
  const x = e.clientX - rect.left;

  const drop = document.createElement("div");
  drop.className = "drop";
  drop.style.left = x - 7 + "px";
  drop.style.top = "-20px";
  game.appendChild(drop);

  // è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®åˆ¤å®š
  let dropY = 0;
  const fallSpeed = 4; // 1ãƒ•ãƒ¬ãƒ¼ãƒ ã‚ãŸã‚Šè½ä¸‹é‡
  let successHit = false;

  const fallInterval = setInterval(() => {
    if (gameOver) {
      clearInterval(fallInterval);
      drop.remove();
      return;
    }

    dropY += fallSpeed;
    drop.style.top = dropY + "px";

    const dropRect = drop.getBoundingClientRect();
    const eyeRect = eye.getBoundingClientRect();

    // ç›®ãŒé–‹ã„ã¦ã„ã¦å½“ãŸã£ãŸã‚‰æˆåŠŸ
    if (!isClosed &&
        dropRect.left < eyeRect.right &&
        dropRect.right > eyeRect.left &&
        dropRect.top < eyeRect.bottom &&
        dropRect.bottom > eyeRect.top) {
      success++;
      successText.textContent = success;
      eye.classList.remove("red");
      successHit = true;
      drop.remove();
      clearInterval(fallInterval);
      if (success === 3) endGame("ğŸ‰ ã‚¯ãƒªã‚¢ï¼");
    }

    // ç”»é¢ä¸‹ã¾ã§åˆ°é”ã—ãŸã‚‰å¤±æ•—ï¼ˆå½“ãŸã£ã¦ãªã‘ã‚Œã°ï¼‰
    if (dropY > game.clientHeight && !successHit) {
      miss++;
      missText.textContent = miss;
      eye.classList.add("red");
      drop.remove();
      clearInterval(fallInterval);
      if (miss === 3) endGame("ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼");
    }
  }, 16); // ç´„60FPS
});

// çµ‚äº†
function endGame(text) {
  gameOver = true;
  message.textContent = text;
  clearInterval(timer);
  clearInterval(pupilTimer);
  clearTimeout(blinkTimeout);
  restartBtn.style.display = "inline-block";
}

// ãƒœã‚¿ãƒ³
startBtn.onclick = startGame;
restartBtn.onclick = startGame;
